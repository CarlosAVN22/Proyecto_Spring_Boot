<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel de Administración — Tourify</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <base href="/" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --bg:#0b0f18; --bg2:#0f1422; --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.14);
          --text:#eef1f4; --muted:#9aa3ad; --accent:#5ec1ff; --radius:16px; }
    body{ color:var(--text); background:
          radial-gradient(1200px 800px at 10% -10%, rgba(94,193,255,.08), transparent 60%),
          radial-gradient(1000px 600px at 110% 0%, rgba(140,122,255,.08), transparent 60%),
          linear-gradient(180deg, var(--bg), var(--bg2)); min-height:100vh; }
    .navglass{ backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
              background: rgba(255,255,255,.06); border-bottom:1px solid var(--border); }
    .card-soft{ border:1px solid var(--border); background:var(--card); border-radius:var(--radius);
                backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
                box-shadow: 0 14px 34px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05); }
    .form-control, .form-select{ color:var(--text); background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14); }
    .form-select option, .form-select optgroup{ color:#111 !important; background:#fff; }
    .form-control::placeholder{ color:#cbd5e1; opacity:.9 }
    .form-control:focus, .form-select:focus{ border-color: var(--accent); box-shadow: 0 0 0 .2rem rgba(94,193,255,.25); background: rgba(255,255,255,.08); }
    label{color:var(--muted); font-weight:600}
    .help{ color: var(--muted); font-size:.9rem }
    .result-card{ display:flex; gap:.75rem; align-items:center; padding:.5rem; border:1px solid rgba(255,255,255,.14);
                  background:rgba(255,255,255,.04); border-radius:12px; cursor:pointer; transition: transform .1s, background .15s, border-color .15s; }
    .result-card:hover{ transform: translateY(-1px); background:rgba(255,255,255,.08); border-color:#fff; }
    .result-card img{ width:64px; height:48px; object-fit:cover; border-radius:8px; background:#111; }
    .result-title{ color:#fff; margin:0; font-weight:700; }
    .result-sub{ color:#cbd5e1; margin:0; font-size:.9rem }
  </style>
</head>
<body>
  <nav class="navglass navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="/paises">Tourify — Admin</a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <span id="whoami" class="small text-secondary"></span>
        <form action="/api/auth/logout" method="post" class="m-0">
          <button class="btn btn-outline-light btn-sm" type="submit">Cerrar sesión</button>
        </form>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="row g-3 mb-3">
      <div class="col-12">
        <div class="card-soft p-3">
          <h1 class="h4 mb-2">Panel de administración</h1>
          <p class="help mb-0">Crear y editar lugares. Categorías y países se cargan de la API.</p>
        </div>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12 col-lg-8">
        <div class="card-soft p-3">
          <h2 class="h5 mb-3">Lugar</h2>

          <form id="formLugar" class="row g-3">
            <input type="hidden" name="lugarId" id="lugarId">

            <div class="col-md-8">
              <label class="form-label">Nombre</label>
              <input class="form-control" name="nombre" placeholder="Ej: Hotel Colonial" required>
            </div>

            <div class="col-md-4">
              <label class="form-label">Categoría</label>
              <select class="form-select" name="categoriaCodigo" id="categoriaCodigo" required>
                <option value="">-- Selecciona --</option>
              </select>
              <div class="help">Se listan de <code>/api/categorias</code>.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">País</label>
              <select class="form-select" name="paisId" id="paisId" required>
                <option value="">-- Selecciona un país --</option>
              </select>
              <div class="help">Se listan de <code>/api/paises</code>.</div>
            </div>

            <div class="col-md-6">
              <label class="form-label">Precio (USD)</label>
              <input type="number" step="0.01" min="0" class="form-control" name="precio" placeholder="0.00">
            </div>

            <div class="col-12">
              <label class="form-label">Dirección</label>
              <input class="form-control" name="direccion" placeholder="Calle, avenida...">
            </div>

            <div class="col-12">
              <label class="form-label">Descripción</label>
              <textarea class="form-control" rows="3" name="descripcion" placeholder="Texto descriptivo..."></textarea>
            </div>

            <div class="col-12">
              <label class="form-label">URL de imagen principal</label>
              <input class="form-control" name="imagenUrl" placeholder="https://... o /uploads/archivo.jpg">
              <div class="help">Usa una URL http(s) o la ruta relativa devuelta por la subida (<code>/uploads/...</code>). <strong>Se ignoran <code>data:image;base64,...</code></strong>.</div>
            </div>

            <!-- NUEVO: subir archivo y autollenar imagenUrl -->
            <div class="col-12">
              <label class="form-label">Subir imagen (archivo)</label>
              <div class="d-flex gap-2">
                <input type="file" id="fileImagen" accept="image/*" class="form-control" style="max-width:420px">
                <button class="btn btn-outline-light" type="button" id="btnUpload">Subir</button>
              </div>
              <div class="help">Se sube a <code>/uploads/</code> y se llena automáticamente el campo URL.</div>
            </div>

            <div class="col-12 d-flex gap-2">
              <button class="btn btn-primary" type="submit">Guardar</button>
              <button class="btn btn-outline-light" type="button" id="btnEditar">Editar…</button>
            </div>

            <div id="msg" class="alert py-2 px-3 mt-2 d-none"></div>
          </form>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card-soft p-3">
          <h2 class="h6 mb-2">Vista previa</h2>
          <div id="preview" class="border rounded p-2" style="border-color:rgba(255,255,255,.14)!important">
            <div class="ratio ratio-16x9 mb-2 bg-dark-subtle" style="background:#111">
              <img id="prevImg" alt="imagen" style="object-fit:cover;width:100%;height:100%;display:none;">
            </div>
            <div class="small text-secondary" id="prevCategoria">—</div>
            <h3 class="h6 mb-1" id="prevNombre">—</h3>
            <div class="d-flex justify-content-between">
              <span id="prevDireccion" class="small text-secondary">—</span>
              <strong id="prevPrecio">$0.00</strong>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODAL -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content" style="background:#141a27;color:#eaeef6;border:1px solid rgba(255,255,255,.15)">
        <div class="modal-header">
          <h5 class="modal-title">Editar lugar existente</h5>
          <button class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3 mb-2">
            <div class="col-md-6">
              <label class="form-label">País</label>
              <select class="form-select" id="filtroPais">
                <option value="">-- Cualquiera --</option>
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Categoría</label>
              <select class="form-select" id="filtroCategoria">
                <option value="">-- Cualquiera --</option>
              </select>
            </div>
          </div>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-primary" id="btnBuscar">Buscar</button>
            <span id="buscando" class="align-self-center small text-secondary d-none">Buscando…</span>
          </div>

          <div id="resultInfo" class="small text-secondary mb-2"></div>
          <div id="resultList" class="vstack gap-2"></div>
          <div id="resultEmpty" class="alert alert-warning d-none mt-2">No hay lugares para esos filtros.</div>
          <div id="resultError" class="alert alert-danger d-none mt-2">No se pudo cargar la lista.</div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline-light" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ---------------- Helpers ----------------
    const safe  = v => v ?? '';
    // NUEVO: permite http(s) y rutas relativas /uploads/...
    const isImgUrl = u => !!u && (/^https?:\/\//i.test(u) || /^\/uploads\//.test(u));
    const labelPais = p => `${safe(p.nombre)} (${ safe(p.codigo) || safe(p.codigoPais) || safe(p.iso3) || '' })`;
    const PLACEHOLDER = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="120"><rect width="100%" height="100%" fill="%23111"/><text x="50%" y="55%" dominant-baseline="middle" text-anchor="middle" fill="%23888" font-family="Arial" font-size="14">sin imagen</text></svg>';

    function bestImage(obj){
      const candidates = [
        obj?.imagenUrl, obj?.imageUrl,
        obj?.imagen?.url, obj?.image?.url,
        Array.isArray(obj?.imagenes) ? (obj.imagenes[0]?.url || obj.imagenes[0]) : null,
        Array.isArray(obj?.images)   ? (obj.images[0]?.url   || obj.images[0])   : null,
        obj?.imagenPrincipal?.url, obj?.mainImage?.url,
        obj?.foto, obj?.fotoUrl, obj?.thumbnail, obj?.thumbUrl
      ].filter(Boolean);
      const valid = candidates.find(isImgUrl);
      return valid || '';
    }

    async function fetchJson(url){
      const res = await fetch(url, { credentials:'same-origin' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }

    // Intenta primero la ruta pública (para evitar 500 en /api/admin/lugares/{id})
    async function fetchLugarDetalle(id){
      const candidates = [
        `/api/lugares/${id}`,              // pública (primero)
        `/api/admin/lugares/${id}`,        // admin (solo si la pública falla)
        `/api/lugares/detalle/${id}`       // otra convención
      ];
      for(const url of candidates){
        try{ return await fetchJson(url); }catch{}
      }
      // Último recurso: intenta obtener SOLO la imagen y combinar
      let base;
      try{ base = await fetchJson(`/api/lugares/${id}`); }catch{ base = { id }; }
      const imagenLists = [
        `/api/imagenes?lugarId=${id}`,
        `/api/admin/imagenes?lugarId=${id}`,
        `/api/lugares/${id}/imagenes`
      ];
      for(const u of imagenLists){
        try{
          const imgs = await fetchJson(u);
          if(Array.isArray(imgs) && imgs.length){
            base.imagenes = imgs;
            break;
          }
        }catch{}
      }
      return base;
    }

    // ---------------- quién está logueado ----------------
    (async () => {
      try {
        const me = await fetchJson('/api/auth/me');
        const who = document.getElementById('whoami');
        who.textContent = me?.authenticated ? `${me.email} · Roles: ${(me.roles||[]).join(',')}` : 'No autenticado';
      } catch {}
    })();

    // ---------------- cargar selects ----------------
    async function loadCategorias(){
      const sels = [document.getElementById('categoriaCodigo'), document.getElementById('filtroCategoria')];
      sels.forEach(s => s.innerHTML = '<option value="">' + (s.id==='categoriaCodigo' ? '-- Selecciona --' : '-- Cualquiera --') + '</option>');
      try{
        const data = await fetchJson('/api/categorias');
        (data||[]).forEach(c=>{
          sels.forEach(sel=>{
            const opt=document.createElement('option');
            opt.value=c.codigo; opt.textContent=safe(c.nombre);
            sel.appendChild(opt);
          });
        });
      }catch{
        ['HOTEL','AIRBNB','PLAYA','PARQUE','RESTAURANTE'].forEach(x=>{
          sels.forEach(sel=>{
            const opt=document.createElement('option'); opt.value=x; opt.textContent=x;
            sel.appendChild(opt);
          });
        });
      }
    }
    async function loadPaises(){
      const sels = [document.getElementById('paisId'), document.getElementById('filtroPais')];
      sels[0].innerHTML = '<option value="">-- Selecciona un país --</option>';
      sels[1].innerHTML = '<option value="">-- Cualquiera --</option>';
      try{
        const data = await fetchJson('/api/paises');
        (data||[]).forEach(p=>{
          const opt1=document.createElement('option'); opt1.value=p.id; opt1.textContent=labelPais(p);
          const opt2=document.createElement('option'); opt2.value=p.id; opt2.textContent=labelPais(p);
          sels[0].appendChild(opt1); sels[1].appendChild(opt2);
        });
      }catch{
        sels.forEach(sel => sel.innerHTML += '<option disabled>(No se pudo cargar)</option>');
      }
    }

    // ---------------- preview ----------------
    function updatePreview(){
      const f = document.getElementById('formLugar');
      const nombre = f.nombre.value.trim() || '—';
      const cat = f.categoriaCodigo.value || '—';
      const direccion = f.direccion.value.trim() || '—';
      const precio = f.precio.value ? Number(f.precio.value).toFixed(2) : '0.00';
      const imgUrl = f.imagenUrl.value.trim();

      document.getElementById('prevNombre').textContent = nombre;
      document.getElementById('prevCategoria').textContent = cat;
      document.getElementById('prevDireccion').textContent = direccion;
      document.getElementById('prevPrecio').textContent = `$${precio}`;

      const img = document.getElementById('prevImg');
      if (isImgUrl(imgUrl)) { img.src = imgUrl; img.style.display = 'block'; }
      else { img.removeAttribute('src'); img.style.display = 'none'; }
    }
    document.getElementById('formLugar')?.addEventListener('input', (e)=>{
      if(['nombre','categoriaCodigo','direccion','precio','imagenUrl','paisId'].includes(e.target.name)) updatePreview();
    });

    // Asegura que el select tenga la opción (si aún no fue cargada)
    function ensureOption(select, value, label){
      if(!value && value !== 0) return;
      const exists = Array.from(select.options).some(o => String(o.value) === String(value));
      if(!exists){
        const opt = document.createElement('option');
        opt.value = value; opt.textContent = label || value;
        select.appendChild(opt);
      }
    }

    // ---------------- llenar form con detalle ----------------
    function fillForm(det){
      const f = document.getElementById('formLugar');
      document.getElementById('lugarId').value = det.id ?? '';

      // categoría
      const catCode = det.categoriaCodigo || det.categoria?.codigo || '';
      ensureOption(document.getElementById('categoriaCodigo'), catCode, catCode);
      f.categoriaCodigo.value = catCode;

      // país
      const paisId = det.paisId ?? det.pais?.id ?? '';
      const paisNombre = det.pais?.nombre || det.paisNombre || '';
      ensureOption(document.getElementById('paisId'), paisId, paisNombre || paisId);
      f.paisId.value = paisId;

      f.nombre.value = safe(det.nombre);
      f.direccion.value = safe(det.direccion);
      f.precio.value = det.precio ?? '';

      // imagen
      const url = bestImage(det);
      f.imagenUrl.value = url || '';

      updatePreview();

      const msg = document.getElementById('msg');
      msg.classList.remove('d-none','alert-danger','alert-success');
      msg.classList.add('alert-info');
      msg.textContent = `Editando ID ${det.id}`;
    }

    // ---------------- guardar ----------------
    document.getElementById('formLugar')?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const f = e.target;
      const msg = document.getElementById('msg');
      msg.classList.remove('d-none','alert-danger','alert-success','alert-info');

      const id = (document.getElementById('lugarId').value||'').trim();
      const rawUrl = (f.imagenUrl.value||'').trim();
      const imagenUrl = isImgUrl(rawUrl) ? rawUrl : null; // acepta /uploads/...

      const payload = {
        nombre: (f.nombre.value||'').trim(),
        categoriaCodigo: f.categoriaCodigo.value || null,
        paisId: f.paisId.value ? Number(f.paisId.value) : null,
        ciudadId: null,
        direccion: (f.direccion.value||'').trim() || null,
        precio: f.precio.value ? Number(f.precio.value) : null,
        imagenUrl
      };

      const url = id ? `/api/admin/lugares/${id}` : '/api/admin/lugares';
      const method = id ? 'PUT' : 'POST';

      try{
        const res = await fetch(url, {
          method,
          headers:{'Content-Type':'application/json'},
          credentials:'same-origin',
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(()=>({}));
        if(res.ok && (data.ok ?? true)){
          msg.classList.add('alert-success');
          msg.textContent = id ? `✔ Lugar ${id} actualizado` : `✔ ${data.message || 'Lugar creado'} (ID ${data.id})`;
          if(!id){ f.reset(); updatePreview(); }
        }else{
          msg.classList.add('alert-danger');
          msg.textContent = data.message || 'No se pudo guardar';
        }
      }catch(err){
        msg.classList.add('alert-danger');
        msg.textContent = 'Error inesperado en el servidor';
      }
    });

    // ---------------- modal editar ----------------
    const editModal = new bootstrap.Modal(document.getElementById('editModal'));

    document.getElementById('btnEditar')?.addEventListener('click', ()=>{
      document.getElementById('filtroPais').value = document.getElementById('paisId').value || '';
      document.getElementById('filtroCategoria').value = document.getElementById('categoriaCodigo').value || '';
      limpiarResultados();
      editModal.show();
    });

    function limpiarResultados(){
      document.getElementById('resultList').innerHTML = '';
      document.getElementById('resultEmpty').classList.add('d-none');
      document.getElementById('resultError').classList.add('d-none');
      document.getElementById('resultInfo').textContent = '';
    }

    async function buscarLugares(){
      limpiarResultados();
      const paisId = document.getElementById('filtroPais').value;
      const cat = document.getElementById('filtroCategoria').value;

      const params = new URLSearchParams();
      if(paisId) params.append('paisId', paisId);
      if(cat) params.append('categoria', cat);

      const url = '/api/lugares' + (params.toString() ? `?${params}` : '');
      document.getElementById('buscando').classList.remove('d-none');

      try{
        const lista = await fetchJson(url);
        const arr = Array.isArray(lista) ? lista : [];

        document.getElementById('resultInfo').textContent = `Resultados: ${arr.length}`;
        if(arr.length === 0){
          document.getElementById('resultEmpty').classList.remove('d-none');
          return;
        }

        const cont = document.getElementById('resultList');

        arr.forEach(l => {
          const card = document.createElement('div');
          card.className = 'result-card';
          card.setAttribute('data-id', l.id);

          const imgEl = document.createElement('img');
          // usa la mejor imagen; acepta /uploads/...
          const thumb = bestImage(l);
          imgEl.src = isImgUrl(thumb) ? thumb : PLACEHOLDER;

          const info = document.createElement('div');
          info.className = 'flex-grow-1';
          const catTxt = safe(l.categoria?.codigo || l.categoriaCodigo || '');
          const paisTxt = safe(l.pais?.nombre || l.paisNombre || '');
          info.innerHTML = `
            <p class="result-title mb-1">#${l.id} · ${safe(l.nombre)}</p>
            <p class="result-sub mb-0">${catTxt}${catTxt && paisTxt ? ' · ' : ''}${paisTxt}</p>
          `;

          card.appendChild(imgEl);
          card.appendChild(info);
          cont.appendChild(card);

          card.addEventListener('click', async ()=>{
            const msg = document.getElementById('msg');
            msg.classList.remove('d-none','alert-danger','alert-success','alert-info');
            msg.classList.add('alert-info');
            msg.textContent = `Cargando detalle #${l.id}…`;
            try{
              const det = await fetchLugarDetalle(l.id);
              // si el detalle tampoco trae, intenta rutas de imágenes y actualiza el objeto
              if(!bestImage(det)){
                for(const u of [
                  `/api/imagenes?lugarId=${l.id}`,
                  `/api/admin/imagenes?lugarId=${l.id}`,
                  `/api/lugares/${l.id}/imagenes`
                ]){
                  try{
                    const imgs = await fetchJson(u);
                    if(Array.isArray(imgs) && imgs.length){ det.imagenes = imgs; break; }
                  }catch{}
                }
              }
              fillForm(det);
              editModal.hide();
              msg.classList.add('alert-info');
              msg.textContent = `Editando ID ${det.id}`;
            }catch(err){
              msg.classList.remove('alert-info','alert-success');
              msg.classList.add('alert-danger');
              msg.textContent = `No se pudo cargar el lugar #${l.id}.`;
            }
          });
        });
      }catch(e){
        document.getElementById('resultError').classList.remove('d-none');
      }finally{
        document.getElementById('buscando').classList.add('d-none');
      }
    }
    document.getElementById('btnBuscar')?.addEventListener('click', buscarLugares);

    // -------- Subida de imagen (multipart -> /api/upload) --------
    async function subirImagen(file){
      const msg = document.getElementById('msg');
      try{
        const fd = new FormData();
        fd.append('file', file);
        const res = await fetch('/api/upload', { method:'POST', body: fd, credentials:'same-origin' });
        const data = await res.json();
        if(!res.ok || !data?.url){
          throw new Error(data?.message || ('HTTP '+res.status));
        }
        // setea la URL en el form y refresca preview
        const f = document.getElementById('formLugar');
        f.imagenUrl.value = data.url;    // ej: /uploads/uuid.jpg
        updatePreview();

        msg.classList.remove('d-none','alert-danger','alert-success','alert-info');
        msg.classList.add('alert-success');
        msg.textContent = '✔ Imagen subida';
      }catch(e){
        const msg = document.getElementById('msg');
        msg.classList.remove('d-none','alert-success','alert-info');
        msg.classList.add('alert-danger');
        msg.textContent = 'No se pudo subir la imagen';
      }
    }
    document.getElementById('btnUpload')?.addEventListener('click', async ()=>{
      const input = document.getElementById('fileImagen');
      if(input.files && input.files[0]){
        await subirImagen(input.files[0]);
      }
    });
    document.getElementById('fileImagen')?.addEventListener('change', async (e)=>{
      if(e.target.files && e.target.files[0]) await subirImagen(e.target.files[0]);
    });

    // ---------------- inicial ----------------
    loadCategorias();
    loadPaises();
    updatePreview();
  </script>
</body>
</html>
